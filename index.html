<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LESSON PLANNER Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Arial&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <style>
        :root { --primary: #0f172a; --accent: #2563eb; --bg-app: #e2e8f0; --paper-width: 216mm; --paper-height: 330mm; } 
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg-app); height: 100vh; display: flex; overflow: hidden; color: #334155; }
        
        /* SIDEBAR */
        .sidebar { width: 380px; background: white; border-right: 1px solid #cbd5e1; display: flex; flex-direction: column; overflow-y: auto; z-index: 10; flex-shrink: 0; }
        .sidebar-header { padding: 20px; background: var(--primary); color: white; }
        .sidebar-header h2 { font-size: 1.2rem; font-weight: 700; margin-bottom: 5px; }
        .sidebar-header p { font-size: 0.8rem; opacity: 0.8; }
        .sidebar-content { padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        
        .section-label { font-size: 0.7rem; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; margin-top: 10px; border-bottom: 2px solid #f1f5f9; padding-bottom: 5px; }
        .form-group label { display: block; font-size: 0.8rem; font-weight: 700; color: #475569; margin-bottom: 4px; }
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.9rem; font-family: 'Roboto', sans-serif; background: #f8fafc; }
        textarea { resize: vertical; min-height: 50px; }
        .row { display: flex; gap: 10px; }
        .row > div { flex: 1; }

        /* BUTTONS */
        .btn-generate { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 6px; font-weight: 700; cursor: pointer; width: 100%; margin-top: 15px; display: flex; justify-content: center; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-generate:hover { background: #1d4ed8; }
        .btn-generate:disabled { background: #94a3b8; cursor: not-allowed; }
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        .btn-secondary { flex: 1; padding: 10px; border: 1px solid #cbd5e1; background: white; border-radius: 6px; font-weight: 600; color: #334155; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 5px; font-size: 0.8rem; transition: 0.2s; }
        .btn-secondary:hover { background: #f1f5f9; }
        .btn-dev { background: #334155; color: white; border: none; margin-top: 5px; }
        .btn-dev:hover { background: #1e293b; }

        /* HOME BUTTON */
        .btn-home-back {
            background: linear-gradient(45deg, #1e3a8a, #2563eb, #3b82f6);
            background-size: 200% 200%;
            animation: gradientBG 6s ease infinite;
            color: white; border: none; padding: 12px; border-radius: 50px;
            font-weight: 700; cursor: pointer; width: 100%; display: flex; justify-content: center; align-items: center; gap: 10px;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3); transition: all 0.3s ease; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 0.5px; margin-bottom: 10px;
        }
        .btn-home-back:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 8px 25px rgba(37, 99, 235, 0.5); }
        .btn-home-back:active { transform: translateY(-1px); }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        /* PREVIEW AREA */
        .preview-area { flex: 1; background: #cbd5e1; padding: 30px; overflow-y: auto; display: flex; justify-content: center; }
        
        .bond-paper { 
            background: white; 
            width: var(--paper-width); 
            min-height: var(--paper-height); 
            padding: 10mm; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.15); 
            margin-bottom: 50px; 
            position: relative; 
            display: flex; 
            flex-direction: column; 
            color: black; 
            font-family: Arial, Helvetica, sans-serif; 
            transition: width 0.3s ease;
        }

        /* Landscape Mode Modifier */
        .bond-paper.landscape {
            width: 330mm; /* Legal Landscape */
            min-height: 216mm; 
            padding: 10mm;
        }

        .official-header { text-align: center; margin-bottom: 15px; font-family: "Bookman Old Style", serif; }
        .official-header img { height: 60px; margin-bottom: 5px; }
        .official-header h5 { margin: 0; font-size: 9pt; font-weight: normal; }
        .official-header h4 { margin: 2px 0; font-size: 10pt; font-weight: bold; text-transform: uppercase; }
        
        /* TABLES */
        .tpl-table { width: 100%; border-collapse: collapse; margin-bottom: 15px; font-size: 9pt; table-layout: fixed; }
        .tpl-table td, .tpl-table th { border: 1px solid black; padding: 4px; vertical-align: top; overflow-wrap: break-word; word-wrap: break-word; }
        
        .header-label { width: 15%; background: #eee; text-align: left; font-weight: bold; vertical-align: middle; font-size: 8pt; }
        .header-val { width: 35%; font-weight: bold; font-size: 9pt;}

        /* DLL Grid specific */
        .dll-grid th { background: #d1d5db; text-align: center; font-weight: bold; font-size: 8pt; vertical-align: middle; }
        .dll-grid td { font-size: 8pt; }
        .dll-row-header { background: #f3f4f6; font-weight: bold; width: 150px; }
        .col-day { width: 18%; }
        
        .signature-section { margin-top: auto; padding-top: 20px; font-size: 9pt; page-break-inside: avoid; display: flex; justify-content: space-between; }
        .sig-block { width: 45%; }
        .sig-name { font-weight: bold; text-transform: uppercase; border-bottom: 1px solid black; display: block; text-align: center; margin-top: 30px; }
        .sig-pos { font-size: 8pt; text-align: center; display: block; margin-top: 4px; }
        
        .spinner { display: none; width: 16px; height: 16px; border: 2px solid #fff; border-bottom-color: transparent; border-radius: 50%; animation: rotation 1s linear infinite; }
        @keyframes rotation { to { transform: rotate(360deg); } }

        /* MARKDOWN CONTENT FIXES */
        .parsed-md ul, .parsed-md ol { padding-left: 15px; margin: 0; }
        .parsed-md p { margin: 0 0 5px 0; }
        .parsed-md strong { font-weight: bold; color: #000; }
        .parsed-md em { font-style: italic; color: #444; }
        
        @media print {
            @page { size: auto; margin: 5mm; } 
            body { background: white; display: block; height: auto; }
            .sidebar { display: none; }
            .preview-area { padding: 0; background: white; display: block; }
            .bond-paper { box-shadow: none; margin: 0; padding: 0; width: 100%; border: none; }
            .bond-paper.landscape { width: 100%; transform: none; }
            .btn-group { display: none; }
        }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header">
        <h2>COGON NATIONAL HIGH SCHOOL</h2>
        <p>LESSON PLANNER Pro</p>
    </div>

    <div class="sidebar-content">
        <button class="btn-home-back" onclick="window.location.href='https://cogonnationalhighschool.com/'">
            <i class="fa-solid fa-school"></i> Go to CNHS Website
        </button>

        <div class="section-label">I. Configuration</div>
        <div class="form-group">
            <label>Document Type</label>
            <select id="docType" onchange="toggleInputs()">
                <option value="DLP">Detailed Lesson Plan (DLP)</option>
                <option value="DLL">Daily Lesson Log (DLL - 1 Week)</option>
            </select>
        </div>

        <div class="form-group"><label>School Name</label><input type="text" id="school" value="COGON NATIONAL HIGH SCHOOL" oninput="liveUpdateHeader()"></div>
        
        <div id="dlp-date-group">
            <div class="form-group"><label>Teacher</label><input type="text" id="teacher" placeholder="Name"></div>
            <div class="row">
                <div class="form-group">
                    <label>Teaching Date</label>
                    <input type="date" id="dlp-date" onchange="renderEmptyLayout()">
                </div>
                <div class="form-group">
                    <label>Teaching Time</label>
                    <input type="text" id="dlp-time" placeholder="e.g. 8:00 - 9:00 AM" oninput="renderEmptyLayout()">
                </div>
            </div>
        </div>

        <div id="dll-date-group" style="display:none;">
            <div class="form-group"><label>Teacher</label><input type="text" id="teacher-dll" placeholder="Name"></div>
            <div class="form-group"><label>Teaching Time</label><input type="text" id="dll-time" placeholder="e.g. 8:00 - 9:00 AM" oninput="renderEmptyLayout()"></div>
            <div class="section-label" style="margin-top:5px; margin-bottom:5px;">Select Dates (Leave blank to skip)</div>
            <div class="row">
                <div class="form-group"><label>Day 1</label><input type="date" id="date-d1" onchange="renderEmptyLayout()"></div>
                <div class="form-group"><label>Day 2</label><input type="date" id="date-d2" onchange="renderEmptyLayout()"></div>
            </div>
            <div class="row">
                <div class="form-group"><label>Day 3</label><input type="date" id="date-d3" onchange="renderEmptyLayout()"></div>
                <div class="form-group"><label>Day 4</label><input type="date" id="date-d4" onchange="renderEmptyLayout()"></div>
            </div>
            <div class="form-group"><label>Day 5</label><input type="date" id="date-d5" onchange="renderEmptyLayout()"></div>
        </div>

        <div class="row">
            <div class="form-group"><label>Grade</label><input type="text" id="grade" placeholder="Grade 11"></div>
            <div class="form-group"><label>Subject</label><input type="text" id="subject" placeholder="Science"></div>
        </div>
        <div class="form-group"><label>Quarter</label><input type="text" id="quarter" placeholder="First Quarter"></div>
        <div class="form-group" id="section-group"><label>Section</label><input type="text" id="section" placeholder="Section Name"></div>

        <div class="section-label">II. Lesson Content</div>
        <div class="form-group"><label>Topic</label><input type="text" id="topic" placeholder="e.g. Plate Tectonics"></div>
        <div class="form-group"><label>Content Stds</label><textarea id="cs" placeholder="Demonstrates..."></textarea></div>
        <div class="form-group"><label>Perf. Stds</label><textarea id="ps" placeholder="Is able to..."></textarea></div>
        <div class="form-group"><label>Competency</label><textarea id="lc" placeholder="Code..."></textarea></div>

        <div class="section-label">III. Settings</div>
        <div class="form-group">
            <label>Instructional Model</label>
            <select id="model">
                <option value="4As">4A's (Activity, Analysis, Abstraction, Application)</option>
                <option value="5Es">5E's (Engage, Explore, Explain, Elaborate, Evaluate)</option>
                <option value="7Es">7E's (Elicit, Engage, Explore, Explain, Elaborate, Evaluate, Extend)</option>
            </select>
        </div>

        <div class="section-label">IV. Signatories</div>
        <div class="row">
            <div class="form-group"><label>Teacher Pos</label><input type="text" id="teacherPos" placeholder="Teacher I"></div>
            <div class="form-group"><label>Checker</label><input type="text" id="checker" placeholder="Head Name"></div>
        </div>
        <div class="form-group"><label>Checker Pos</label><input type="text" id="checkerPos" placeholder="Principal III"></div>

        <button class="btn-generate" onclick="generatePlan()">
            <span class="spinner" id="spin"></span> <span id="btnText">Generate Plan</span>
        </button>

        <div class="btn-group">
            <button class="btn-secondary" onclick="window.print()"><i class="fa-solid fa-print"></i> PDF/Print</button>
            <button class="btn-secondary" onclick="exportToWord()"><i class="fa-solid fa-file-word"></i> Word</button>
        </div>
        <button class="btn-secondary btn-dev" onclick="showDevInfo()"><i class="fa-solid fa-code"></i> About Developer</button>
        <div style="height: 50px;"></div>
    </div>
</div>

<div class="preview-area">
    <div class="bond-paper" id="paperContent">
        
        <div class="official-header">
            <img src="logo.png" alt="School Logo" onerror="this.style.display='none'">
            <h5>Republic of the Philippines</h5>
            <h5>Department of Education</h5>
            <h5>Region XI</h5>
            <h4 id="displaySchoolHeader">COGON NATIONAL HIGH SCHOOL</h4>
            <h5>Division of the Island Garden City of Samal</h5>
        </div>

        <div id="headerArea"></div>

        <div id="contentArea"></div>

        <div class="signature-section">
            <div class="sig-block"><div>PREPARED BY:</div><div class="sig-name" id="sigTeacherName"></div><div class="sig-pos" id="sigTeacherPos"></div></div>
            <div class="sig-block"><div>CHECKED BY:</div><div class="sig-name" id="sigCheckerName"></div><div class="sig-pos" id="sigCheckerPos"></div></div>
        </div>
    </div>
</div>

<script>
    function toggleInputs() {
        const type = document.getElementById('docType').value;
        const paper = document.getElementById('paperContent');
        const dlpGroup = document.getElementById('dlp-date-group');
        const dllGroup = document.getElementById('dll-date-group');

        if(type === 'DLL') {
            paper.classList.add('landscape');
            dlpGroup.style.display = 'none';
            dllGroup.style.display = 'block';
        } else {
            // DLP uses unified landscape template
            paper.classList.add('landscape'); 
            dlpGroup.style.display = 'block';
            dllGroup.style.display = 'none';
        }
        renderEmptyLayout(); 
    }

    function getInputs() {
        const type = document.getElementById('docType').value;
        const teacherName = type === 'DLL' ? document.getElementById('teacher-dll').value : document.getElementById('teacher').value;
        const isDLP = type === 'DLP';
        const teachingTime = isDLP ? document.getElementById('dlp-time').value : document.getElementById('dll-time').value;
        
        return {
            docType: type,
            school: document.getElementById('school').value, 
            teacher: teacherName,
            dlpDate: document.getElementById('dlp-date').value, 
            teachingTime: teachingTime,
            dates: [
                document.getElementById('date-d1').value,
                document.getElementById('date-d2').value,
                document.getElementById('date-d3').value,
                document.getElementById('date-d4').value,
                document.getElementById('date-d5').value
            ],
            grade: document.getElementById('grade').value,
            subject: document.getElementById('subject').value, 
            quarter: document.getElementById('quarter').value,
            section: document.getElementById('section').value,
            topic: document.getElementById('topic').value, 
            cs: document.getElementById('cs').value,
            ps: document.getElementById('ps').value, 
            lc: document.getElementById('lc').value,
            model: document.getElementById('model').value, 
            teacherPos: document.getElementById('teacherPos').value,
            checker: document.getElementById('checker').value, 
            checkerPos: document.getElementById('checkerPos').value
        };
    }
    
    function liveUpdateHeader() {
        const val = document.getElementById('school').value;
        document.getElementById('displaySchoolHeader').innerText = val ? val.toUpperCase() : "SCHOOL NAME";
        renderEmptyLayout();
    }

    function renderEmptyLayout() {
        const data = getInputs();
        const headerArea = document.getElementById('headerArea');
        const contentArea = document.getElementById('contentArea');

        document.getElementById('sigTeacherName').innerText = data.teacher.toUpperCase();
        document.getElementById('sigTeacherPos').innerText = data.teacherPos.toUpperCase();
        document.getElementById('sigCheckerName').innerText = data.checker.toUpperCase();
        document.getElementById('sigCheckerPos').innerText = data.checkerPos.toUpperCase();

        const isDLP = data.docType === 'DLP';
        const colSpan = isDLP ? 1 : 5;
        
        const colsHTML = isDLP 
            ? `<th style="width:70%">Detailed Content</th>` 
            : data.dates.map((d, i) => `<th class="col-day">${d ? 'Day '+(i+1)+'<br><span style="font-weight:normal;font-size:7pt">'+d+'</span>' : 'Day '+(i+1)}</th>`).join('');

        const dateDisplay = isDLP ? data.dlpDate : data.dates.filter(d => d).join(' / ');

        headerArea.innerHTML = `
            <table class="tpl-table" style="margin-bottom:5px;">
                <tr>
                    <td class="header-label">School</td><td class="header-val">${data.school.toUpperCase()}</td>
                    <td class="header-label">Grade Level</td><td class="header-val">${data.grade}</td>
                </tr>
                <tr>
                    <td class="header-label">Teacher</td><td class="header-val">${data.teacher.toUpperCase()}</td>
                    <td class="header-label">Learning Area</td><td class="header-val">${data.subject}</td>
                </tr>
                <tr>
                    <td class="header-label">Teaching Date/s</td><td class="header-val" style="font-size:8pt">${dateDisplay}</td>
                    <td class="header-label">Quarter</td><td class="header-val">${data.quarter}</td>
                </tr>
                <tr>
                     <td class="header-label">Teaching Time</td><td class="header-val">${data.teachingTime}</td>
                     <td class="header-label">Section</td><td class="header-val">${data.section}</td>
                </tr>
            </table>
        `;

        let gridRows = '';
        const steps = [
            { id: 'a', label: 'A. Review / Presenting new lesson' },
            { id: 'b', label: 'B. Establishing purpose' },
            { id: 'c', label: 'C. Presenting examples' },
            { id: 'd', label: 'D. Discussing new concepts #1' },
            { id: 'e', label: 'E. Discussing new concepts #2' },
            { id: 'f', label: 'F. Developing Mastery' },
            { id: 'g', label: 'G. Finding practical applications' },
            { id: 'h', label: 'H. Making generalizations' },
            { id: 'i', label: 'I. Evaluating learning' },
            { id: 'j', label: 'J. Additional activities' }
        ];

        gridRows += `
            <tr>
                <td style="background:#e5e7eb; font-weight:bold;">II. CONTENT</td>
                ${isDLP ? '<td id="d1-content" class="parsed-md"></td>' : 
                  '<td id="d1-content" class="parsed-md"></td><td id="d2-content" class="parsed-md"></td><td id="d3-content" class="parsed-md"></td><td id="d4-content" class="parsed-md"></td><td id="d5-content" class="parsed-md"></td>'}
            </tr>
            <tr><td colspan="${colSpan+1}" style="background:#e5e7eb; font-weight:bold;">III. LEARNING RESOURCES</td></tr>
            <tr><td class="dll-row-header">A. References</td><td colspan="${colSpan}" id="cell-resources-dll" class="parsed-md"></td></tr>
            <tr><td colspan="${colSpan+1}" style="background:#e5e7eb; font-weight:bold;">IV. PROCEDURES</td></tr>
        `;

        steps.forEach(s => {
            gridRows += `<tr><td class="dll-row-header">${s.label}</td>`;
            if(isDLP) {
                gridRows += `<td id="d1-proc-${s.id}" class="parsed-md"></td>`;
            } else {
                for(let i=1; i<=5; i++) gridRows += `<td id="d${i}-proc-${s.id}" class="parsed-md"></td>`;
            }
            gridRows += `</tr>`;
        });

        contentArea.innerHTML = `
            <table class="tpl-table dll-grid">
                <tr>
                    <th style="width:150px"></th>
                    ${colsHTML}
                </tr>
                <tr><td colspan="${colSpan+1}" style="background:#e5e7eb; font-weight:bold;">I. OBJECTIVES</td></tr>
                <tr><td class="dll-row-header">A. Content Standards</td><td colspan="${colSpan}" id="cell-cs" class="parsed-md">${data.cs || '<i>Generating...</i>'}</td></tr>
                <tr><td class="dll-row-header">B. Performance Standards</td><td colspan="${colSpan}" id="cell-ps" class="parsed-md">${data.ps || '<i>Generating...</i>'}</td></tr>
                <tr><td class="dll-row-header">C. Learning Competencies</td><td colspan="${colSpan}" id="cell-lc" class="parsed-md">${data.lc || '<i>Generating...</i>'}</td></tr>
                ${gridRows}
                <tr><td class="dll-row-header">V. REMARKS</td><td colspan="${colSpan}" style="height:30px"></td></tr>
                <tr><td class="dll-row-header">VI. REFLECTION</td><td colspan="${colSpan}" style="height:30px"></td></tr>
            </table>
        `;
    }

    function extractSection(text, tagName) {
        const regex = new RegExp(`<${tagName}>([\\s\\S]*?)<\/${tagName}>`, 'i');
        const match = text.match(regex);
        return match ? match[1].trim() : null;
    }

    function cleanOutput(text) {
        if(!text) return "";
        let clean = text.replace(/Support Pollinations\.AI[\s\S]*/gi, '');
        clean = clean.replace(/```xml/gi, '').replace(/```/gi, ''); 
        const filters = [
            /AFTER Application\/Elaborate, insert Rubric:/gi,
            /\*\*AFTER Application\/Elaborate, insert Rubric:\*\*/gi,
            /\(INTERNAL:[\s\S]*?\)/gi,
        ];
        filters.forEach(regex => { clean = clean.replace(regex, ''); });
        return clean;
    }
    
    function showDevInfo() {
        Swal.fire({
            title: '<strong>LESSON PLANNER Pro</strong>',
            icon: 'info',
            html: '<b>COGON NATIONAL HIGH SCHOOL</b><br>Developed by: <b>Joram V. Castro</b>',
            showCloseButton: true, confirmButtonText: 'Close', confirmButtonColor: '#2563eb'
        });
    }

    async function generatePlan() {
        const data = getInputs();
        
        // --- OFFLINE CHECK ---
        if (window.location.protocol === 'file:') {
            Swal.fire({ icon: 'error', title: 'Offline Mode Error', html: 'You cannot run this file directly.<br>Please use <b>Live Server</b> in VS Code or upload to <b>GitHub Pages</b>.' });
            return;
        }

        if(!data.topic) { 
            Swal.fire({ icon: 'error', title: 'Missing Information', text: 'Please enter a Topic before generating.' });
            return; 
        }

        renderEmptyLayout();
        const btn = document.querySelector('.btn-generate'); const spinner = document.getElementById('spin');
        btn.disabled = true; spinner.style.display = 'inline-block';
        
        let prompt = "";
        const isDLP = data.docType === 'DLP';
        const model = data.model;

        // --- MAPPING LOGIC ---
        let modelInstructions = "";
        if (model === "4As") {
            modelInstructions = `
                STRICT 4A's MAPPING TO DEPED STEPS:
                - ACTIVITY Phase -> Put inside Step C (Presenting examples) and D (Discussing #1).
                - ANALYSIS Phase -> Put inside Step E (Discussing #2).
                - ABSTRACTION Phase -> Put inside Step H (Generalization).
                - APPLICATION Phase -> Put inside Step G (Application).
                *LABEL THE PHASES IN THE TEXT (e.g., "**[ACTIVITY PHASE]** ...")*
            `;
        } else if (model === "5Es") {
            modelInstructions = `
                STRICT 5E's MAPPING TO DEPED STEPS:
                - ENGAGE Phase -> Put inside Step A (Review) and B (Purpose).
                - EXPLORE Phase -> Put inside Step C (Examples) and D (Discussing #1).
                - EXPLAIN Phase -> Put inside Step E (Discussing #2) and F (Mastery).
                - ELABORATE Phase -> Put inside Step G (Application) and H (Generalization).
                - EVALUATE Phase -> Put inside Step I (Evaluation).
                *LABEL THE PHASES IN THE TEXT (e.g., "**[ENGAGE PHASE]** ...")*
            `;
        } else {
             modelInstructions = `
                STRICT 7E's MAPPING:
                - ELICIT/ENGAGE -> Step A/B.
                - EXPLORE -> Step C/D.
                - EXPLAIN -> Step E.
                - ELABORATE -> Step F/G/H.
                - EVALUATE -> Step I.
                - EXTEND -> Step J.
                *LABEL THE PHASES IN THE TEXT*
             `;
        }

        const commonInst = `
            Standards Inputs: CS Input: "${data.cs || 'None'}", PS: "${data.ps || 'None'}", LC: "${data.lc || 'None'}".
            
            MANDATORY RULES:
            1. **Content Standards (<CS>)**: MUST include Cognitive, Psychomotor, and Affective objectives AND Integration of 3 subjects.
               FORMATTING: Separate these items with double newlines (\n\n) so they appear on new lines in the table.
            2. **Procedures**: Follow the ${model} Model using the mapping below.
            ${modelInstructions}
            3. **Rubrics**: For EVERY procedure step that involves an activity, include a SIMPLE RUBRIC (e.g., "5pts: Accurate... 3pts: ...").
            4. **Resources**: Specific references/links required.
        `;

        if (isDLP) {
            prompt = `
                Act as DepEd Teacher. Create a DETAILED Lesson Plan (DLP) for "${data.topic}" (${data.subject}, ${data.grade}) using the **${model} Model**.
                ${commonInst}
                
                Generate XML Tags:
                <CS>Content Stds\n\nCognitive: ...\n\nPsychomotor: ...\n\nAffective: ...\n\nIntegration: ...</CS> 
                <PS>${data.ps ? data.ps : 'Generate'}</PS> 
                <LC>${data.lc ? data.lc : 'Generate'}</LC>
                <RESOURCES>List references</RESOURCES>

                <D1_C>(Topic)</D1_C>
                <D1_A>(Step A)</D1_A> <D1_B>(Step B)</D1_B> <D1_C_Proc>(Step C)</D1_C_Proc>
                <D1_D>(Step D)</D1_D> <D1_E>(Step E)</D1_E> <D1_F>(Step F)</D1_F> 
                <D1_G>(Step G)</D1_G> <D1_H>(Step H)</D1_H> <D1_I>(Step I)</D1_I> <D1_J>(Step J)</D1_J>
                
                NOTE: Omit REMARKS/REFLECTION. Use Markdown.
            `;
        } else {
            const activeIndices = [];
            data.dates.forEach((d, i) => { if(d) activeIndices.push(i+1); });
            const activeDaysStr = activeIndices.length > 0 ? `Generate content ONLY for these days: ${activeIndices.map(i=>'Day '+i).join(', ')}.` : "Generate content for all 5 days.";

            prompt = `
                Act as DepEd Teacher. Create a 5-DAY Daily Lesson Log (DLL) for "${data.topic}" (${data.subject}, ${data.grade}) using **${model}**.
                ${commonInst}
                ${activeDaysStr}

                Generate XML Tags:
                <CS>Content Stds\n\nCognitive: ...\n\nPsychomotor: ...\n\nAffective: ...\n\nIntegration: ...</CS> 
                <PS>${data.ps ? data.ps : 'Generate'}</PS> 
                <LC>${data.lc ? data.lc : 'Generate'}</LC> 
                <RESOURCES>Refs</RESOURCES>

                Day 1: <D1_C>...</D1_C> <D1_A>...</D1_A> <D1_B>...</D1_B> <D1_C_Proc>...</D1_C_Proc> <D1_D>...</D1_D> <D1_E>...</D1_E> <D1_F>...</D1_F> <D1_G>...</D1_G> <D1_H>...</D1_H> <D1_I>...</D1_I> <D1_J>...</D1_J>
                Day 2: <D2_C>...</D2_C> ...
                Day 3: <D3_C>...</D3_C> ...
                Day 4: <D4_C>...</D4_C> ...
                Day 5: <D5_C>...</D5_C> ...
            `;
        }

        try {
            const response = await fetch('https://text.pollinations.ai/', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ messages: [{ role: 'system', content: 'You are a DepEd Lesson Plan generator. Use XML Tags.' }, { role: 'user', content: prompt }], model: 'openai', seed: Math.floor(Math.random() * 999999) }) });
            if (response.status === 502) throw new Error("Server overloaded (502). Wait 30s & try again.");
            let text = await response.text();
            text = cleanOutput(text);

            const cs = extractSection(text, 'CS');
            const ps = extractSection(text, 'PS');
            const lc = extractSection(text, 'LC');
            const res = extractSection(text, 'RESOURCES');
            if(cs) document.getElementById('cell-cs').innerHTML = marked.parse(cs);
            if(ps) document.getElementById('cell-ps').innerHTML = marked.parse(ps);
            if(lc) document.getElementById('cell-lc').innerHTML = marked.parse(lc);
            if(res) document.getElementById('cell-resources-dll').innerHTML = marked.parse(res);

            const maxDays = isDLP ? 1 : 5;
            for(let i=1; i<=maxDays; i++) {
                if(!isDLP && !document.getElementById(`date-d${i}`).value) continue;

                const content = extractSection(text, `D${i}_C`);
                if(content) document.getElementById(`d${i}-content`).innerHTML = marked.parse(content);
                
                const steps = ['A','B','C','D','E','F','G','H','I','J'];
                steps.forEach(s => {
                    let tag = `D${i}_${s}`;
                    if(s === 'C') tag = `D${i}_C_Proc`; 
                    const val = extractSection(text, tag);
                    if(val) document.getElementById(`d${i}-proc-${s.toLowerCase()}`).innerHTML = marked.parse(val);
                });
            }
            Swal.fire({ icon: 'success', title: 'Lesson Plan Generated!', timer: 1800, showConfirmButton: false });
        } catch (e) { 
            Swal.fire({ icon: 'error', title: 'Server Error', text: e.message });
        } finally { btn.disabled = false; spinner.style.display = 'none'; }
    }
    
    toggleInputs();
    liveUpdateHeader();
</script>
</body>
</html>
