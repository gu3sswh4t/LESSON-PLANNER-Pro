<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LESSON PLANNER Pro</title>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Arial&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { 
            --primary: #0f172a; 
            --accent: #2563eb; 
            --bg-app: #e2e8f0; 
            --paper-width: 297mm; 
            --paper-height: 210mm; 
        } 
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: 'Roboto', sans-serif; background: var(--bg-app); height: 100vh; display: flex; overflow: hidden; color: #334155; }
        
        .sidebar { width: 380px; background: white; border-right: 1px solid #cbd5e1; display: flex; flex-direction: column; overflow-y: auto; z-index: 10; flex-shrink: 0; }
        .sidebar-header { padding: 20px; background: var(--primary); color: white; }
        .sidebar-header h2 { font-size: 1.2rem; font-weight: 700; margin-bottom: 5px; }
        .sidebar-header p { font-size: 0.8rem; opacity: 0.8; }
        .sidebar-content { padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        
        .section-label { font-size: 0.7rem; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; margin-top: 10px; border-bottom: 2px solid #f1f5f9; padding-bottom: 5px; }
        .form-group label { display: block; font-size: 0.8rem; font-weight: 700; color: #475569; margin-bottom: 4px; }
        /* Error state class */
        .input-error { border: 2px solid #ef4444 !important; background-color: #fef2f2 !important; }
        
        input, select, textarea { width: 100%; padding: 8px; border: 1px solid #cbd5e1; border-radius: 4px; font-size: 0.9rem; font-family: 'Roboto', sans-serif; background: #f8fafc; }
        textarea { resize: vertical; min-height: 50px; }
        .row { display: flex; gap: 10px; }
        .row > div { flex: 1; }

        .btn-generate { background: var(--accent); color: white; border: none; padding: 12px; border-radius: 6px; font-weight: 700; cursor: pointer; width: 100%; margin-top: 15px; display: flex; justify-content: center; align-items: center; gap: 8px; transition: 0.2s; }
        .btn-generate:hover { background: #1d4ed8; }
        .btn-generate:disabled { background: #94a3b8; cursor: not-allowed; }
        
        .btn-group { display: flex; flex-direction: column; gap: 8px; margin-top: 10px; }
        .btn-secondary { padding: 10px; border: 1px solid #cbd5e1; background: white; border-radius: 6px; font-weight: 600; color: #334155; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 5px; font-size: 0.8rem; transition: 0.2s; width: 100%; }
        .btn-secondary:hover { background: #f1f5f9; }
        .btn-dev { background: #334155; color: white; border: none; margin-top: 5px; }
        .btn-dev:hover { background: #1e293b; }

        .btn-home-back {
            background: linear-gradient(45deg, #1e3a8a, #2563eb, #3b82f6);
            background-size: 200% 200%;
            animation: gradientBG 6s ease infinite;
            color: white; border: none; padding: 12px; border-radius: 50px;
            font-weight: 700; cursor: pointer; width: 100%; display: flex; justify-content: center; align-items: center; gap: 10px;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3); transition: all 0.3s ease; text-transform: uppercase; font-size: 0.85rem; letter-spacing: 0.5px; margin-bottom: 10px;
        }
        .btn-home-back:hover { transform: translateY(-3px) scale(1.02); box-shadow: 0 8px 25px rgba(37, 99, 235, 0.5); }
        .btn-home-back:active { transform: translateY(-1px); }
        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .preview-area { flex: 1; background: #cbd5e1; padding: 30px; overflow-y: auto; display: flex; justify-content: center; }
        
        .bond-paper { 
            background: white; 
            width: var(--paper-width); 
            min-height: var(--paper-height); 
            padding: 10mm; 
            box-shadow: 0 10px 40px rgba(0,0,0,0.15); 
            margin-bottom: 50px; 
            position: relative; 
            display: flex; 
            flex-direction: column; 
            color: black; 
            font-family: Arial, Helvetica, sans-serif; 
            transition: width 0.3s ease;
        }

        .bond-paper.landscape {
            width: 297mm; 
            min-height: 210mm; 
            padding: 10mm;
        }

        .official-header { text-align: center; margin-bottom: 15px; font-family: "Bookman Old Style", serif; }
        .official-header img { height: 60px; margin-bottom: 5px; }
        .official-header h5 { margin: 0; font-size: 9pt; font-weight: normal; }
        .official-header h4 { margin: 2px 0; font-size: 10pt; font-weight: bold; text-transform: uppercase; }
        
        /* TABLE STYLING FOR OVERFLOW PROTECTION */
        .tpl-table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-bottom: 15px; 
            font-size: 9pt; 
            table-layout: fixed; /* STRICT WIDTHS */
        }
        
        .tpl-table td, .tpl-table th { 
            border: 1px solid black; 
            padding: 4px; 
            vertical-align: top; 
            word-wrap: break-word;          
            overflow-wrap: break-word;      
            word-break: break-word;         
            white-space: pre-wrap;          
        }
        
        .header-label { width: 15%; background: #eee; text-align: left; font-weight: bold; vertical-align: middle; font-size: 8pt; }
        .header-val { width: 35%; font-weight: bold; font-size: 9pt;}

        .dll-grid th { background: #d1d5db; text-align: center; font-weight: bold; font-size: 8pt; vertical-align: middle; }
        .dll-grid td { font-size: 8pt; }
        .dll-row-header { background: #f3f4f6; font-weight: bold; width: 150px; }
        .col-day { width: 18%; }
        
        .signature-section { margin-top: auto; padding-top: 20px; font-size: 9pt; page-break-inside: avoid; display: flex; justify-content: space-between; }
        .sig-block { width: 45%; }
        .sig-name { font-weight: bold; text-transform: uppercase; border-bottom: 1px solid black; display: block; text-align: center; margin-top: 30px; }
        .sig-pos { font-size: 8pt; text-align: center; display: block; margin-top: 4px; }
        
        .spinner { display: none; width: 16px; height: 16px; border: 2px solid #fff; border-bottom-color: transparent; border-radius: 50%; animation: rotation 1s linear infinite; }
        @keyframes rotation { to { transform: rotate(360deg); } }

        .parsed-md ul, .parsed-md ol { padding-left: 15px; margin: 0; }
        .parsed-md p { margin: 0 0 5px 0; }
        .parsed-md strong { font-weight: bold; color: #000; }
        .parsed-md em { font-style: italic; color: #444; }
        
        @media print {
            @page { 
                size: A4 landscape; 
                margin: 5mm; 
            }
            body { 
                background: white; 
                display: block; 
                height: auto; 
                -webkit-print-color-adjust: exact; 
            }
            .sidebar { display: none; }
            .preview-area { padding: 0; background: white; display: block; }
            
            .bond-paper { 
                box-shadow: none; 
                margin: 0; 
                padding: 0; 
                width: 100% !important; 
                border: none;
                overflow: visible !important;
                transform: scale(0.98); 
                transform-origin: top left;
            }
            
            .bond-paper.landscape { width: 100% !important; }
            .btn-group { display: none; }
            .tpl-table td, .tpl-table th { font-size: 8.5pt !important; page-break-inside: avoid; }
        }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="sidebar-header">
        <h2>COGON NATIONAL HIGH SCHOOL</h2>
        <p>LESSON PLANNER Pro</p>
    </div>

    <div class="sidebar-content">
        <button class="btn-home-back" onclick="window.location.href='https://cogonnationalhighschool.com/'">
            <i class="fa-solid fa-school"></i> Go to CNHS Website
        </button>

        <div class="section-label">I. Configuration</div>
        <div class="form-group">
            <label>Document Type *</label>
            <select id="docType" onchange="toggleInputs()">
                <option value="" disabled selected>Select Document Type...</option>
                <option value="DLP">Detailed Lesson Plan (DLP)</option>
                <option value="DLL">Daily Lesson Log (DLL - 1 Week)</option>
            </select>
        </div>

        <div class="form-group"><label>School Name</label><input type="text" id="school" value="COGON NATIONAL HIGH SCHOOL" oninput="liveUpdateHeader()"></div>
        
        <div id="dlp-date-group" style="display:none;">
            <div class="form-group"><label>Teacher *</label><input type="text" id="teacher" placeholder="Name"></div>
            <div class="row">
                <div class="form-group">
                    <label>Teaching Date *</label>
                    <input type="date" id="dlp-date" onchange="renderEmptyLayout()">
                </div>
                <div class="form-group">
                    <label>Teaching Time *</label>
                    <input type="text" id="dlp-time" placeholder="e.g. 8:00 - 9:00 AM" oninput="renderEmptyLayout()">
                </div>
            </div>
        </div>

        <div id="dll-date-group" style="display:none;">
            <div class="form-group"><label>Teacher *</label><input type="text" id="teacher-dll" placeholder="Name"></div>
            <div class="form-group"><label>Teaching Time *</label><input type="text" id="dll-time" placeholder="e.g. 8:00 - 9:00 AM" oninput="renderEmptyLayout()"></div>
            <div class="section-label" style="margin-top:5px; margin-bottom:5px;">Select Dates (At least one)</div>
            <div class="row">
                <div class="form-group"><label>Day 1</label><input type="date" id="date-d1" onchange="renderEmptyLayout()"></div>
                <div class="form-group"><label>Day 2</label><input type="date" id="date-d2" onchange="renderEmptyLayout()"></div>
            </div>
            <div class="row">
                <div class="form-group"><label>Day 3</label><input type="date" id="date-d3" onchange="renderEmptyLayout()"></div>
                <div class="form-group"><label>Day 4</label><input type="date" id="date-d4" onchange="renderEmptyLayout()"></div>
            </div>
            <div class="form-group"><label>Day 5</label><input type="date" id="date-d5" onchange="renderEmptyLayout()"></div>
        </div>

        <div class="row">
            <div class="form-group">
                <label>Grade Level *</label>
                <select id="grade" onchange="renderEmptyLayout()">
                    <option value="" disabled selected>Select Grade...</option>
                    <option value="Grade 1">Grade 1</option>
                    <option value="Grade 2">Grade 2</option>
                    <option value="Grade 3">Grade 3</option>
                    <option value="Grade 4">Grade 4</option>
                    <option value="Grade 5">Grade 5</option>
                    <option value="Grade 6">Grade 6</option>
                    <option value="Grade 7">Grade 7</option>
                    <option value="Grade 8">Grade 8</option>
                    <option value="Grade 9">Grade 9</option>
                    <option value="Grade 10">Grade 10</option>
                    <option value="Grade 11">Grade 11</option>
                    <option value="Grade 12">Grade 12</option>
                </select>
            </div>
            <div class="form-group">
                <label>Quarter *</label>
                <select id="quarter" onchange="renderEmptyLayout()">
                    <option value="" disabled selected>Select Quarter...</option>
                    <option value="1st Quarter">1st Quarter</option>
                    <option value="2nd Quarter">2nd Quarter</option>
                    <option value="3rd Quarter">3rd Quarter</option>
                    <option value="4th Quarter">4th Quarter</option>
                </select>
            </div>
        </div>

        <div class="form-group">
            <label>Subject *</label>
            <select id="subjectSelect" onchange="handleSubjectChange()">
                <option value="" disabled selected>Select Subject...</option>
                <option value="Science">Science</option>
                <option value="Mathematics">Mathematics</option>
                <option value="English">English</option>
                <option value="Filipino">Filipino</option>
                <option value="Araling Panlipunan">Araling Panlipunan</option>
                <option value="MAPEH">MAPEH</option>
                <option value="TLE">TLE</option>
                <option value="ESP">ESP</option>
                <option value="Empowerment Technologies">Empowerment Technologies</option>
                <option value="Introduction to Philosophy">Introduction to Philosophy</option>
                <option value="Oral Communication">Oral Communication</option>
                <option value="Manual">Enter Manually...</option>
            </select>
            <input type="text" id="subjectManual" placeholder="Type Subject Name" style="display:none; margin-top:5px;" oninput="renderEmptyLayout()">
        </div>

        <div class="form-group" id="section-group"><label>Section *</label><input type="text" id="section" placeholder="Section Name"></div>

        <div class="section-label">II. Lesson Content</div>
        <div class="form-group"><label>Topic *</label><input type="text" id="topic" placeholder="e.g. Plate Tectonics"></div>
        <div class="form-group"><label>Content Stds *</label><textarea id="cs" placeholder="Demonstrates..."></textarea></div>
        <div class="form-group"><label>Perf. Stds *</label><textarea id="ps" placeholder="Is able to..."></textarea></div>
        <div class="form-group"><label>Competency *</label><textarea id="lc" placeholder="Code..."></textarea></div>

        <div class="section-label">III. Settings</div>
        <div class="form-group">
            <label>Instructional Model *</label>
            <select id="model">
                <option value="" disabled selected>Select Model...</option>
                <option value="4As">4A's (Activity, Analysis, Abstraction, Application)</option>
                <option value="5Es">5E's (Engage, Explore, Explain, Elaborate, Evaluate)</option>
                <option value="7Es">7E's (Elicit, Engage, Explore, Explain, Elaborate, Evaluate, Extend)</option>
            </select>
        </div>

        <div class="section-label">IV. Signatories</div>
        <div class="row">
            <div class="form-group"><label>Teacher Pos *</label><input type="text" id="teacherPos" placeholder="Teacher I"></div>
            <div class="form-group"><label>Checker *</label><input type="text" id="checker" placeholder="Head Name"></div>
        </div>
        <div class="form-group"><label>Checker Pos *</label><input type="text" id="checkerPos" placeholder="Principal III"></div>

        <button class="btn-generate" onclick="generatePlan()">
            <span class="spinner" id="spin"></span> <span id="btnText">Generate Plan</span>
        </button>

        <div class="btn-group">
            <button class="btn-secondary" onclick="window.print()">
                <i class="fa-solid fa-print"></i> PRINT
            </button>
            <button class="btn-secondary" onclick="downloadPDF()">
                <i class="fa-solid fa-file-pdf"></i> Download PDF
            </button>
            <button class="btn-secondary" onclick="exportToWord()">
                <i class="fa-solid fa-file-word"></i> Download WORD
            </button>
        </div>
        
        <button class="btn-secondary btn-dev" onclick="showDevInfo()"><i class="fa-solid fa-code"></i> About Developer</button>
        <div style="height: 50px;"></div>
    </div>
</div>

<div class="preview-area">
    <div class="bond-paper" id="paperContent">
        <div class="official-header">
            <img id="headerLogo" src="logo.png" alt="School Logo" crossorigin="anonymous" onerror="this.style.display='none'">
            <h5>Republic of the Philippines</h5>
            <h5>Department of Education</h5>
            <h5>Region XI</h5>
            <h4 id="displaySchoolHeader">COGON NATIONAL HIGH SCHOOL</h4>
            <h5>Division of the Island Garden City of Samal</h5>
        </div>
        <div id="headerArea"></div>
        <div id="contentArea"></div>
        <div class="signature-section">
            <div class="sig-block"><div>PREPARED BY:</div><div class="sig-name" id="sigTeacherName"></div><div class="sig-pos" id="sigTeacherPos"></div></div>
            <div class="sig-block"><div>CHECKED BY:</div><div class="sig-name" id="sigCheckerName"></div><div class="sig-pos" id="sigCheckerPos"></div></div>
        </div>
    </div>
</div>

<script>
    function toggleInputs() {
        const type = document.getElementById('docType').value;
        const paper = document.getElementById('paperContent');
        const dlpGroup = document.getElementById('dlp-date-group');
        const dllGroup = document.getElementById('dll-date-group');

        if(type === 'DLL') {
            paper.classList.add('landscape');
            dlpGroup.style.display = 'block';
            dllGroup.style.display = 'block'; // Logic check: DLP group should be none? Correcting below
            document.getElementById('dlp-date-group').style.display = 'none';
        } else if (type === 'DLP') {
            paper.classList.add('landscape'); 
            dlpGroup.style.display = 'block';
            dllGroup.style.display = 'none';
        } else {
            // Default state if nothing selected (though logic handles this)
            dlpGroup.style.display = 'none';
            dllGroup.style.display = 'none';
        }
        renderEmptyLayout(); 
    }

    function handleSubjectChange() {
        const select = document.getElementById('subjectSelect');
        const manualInput = document.getElementById('subjectManual');
        if (select.value === 'Manual') {
            manualInput.style.display = 'block';
        } else {
            manualInput.style.display = 'none';
        }
        renderEmptyLayout();
    }

    function getInputs() {
        const type = document.getElementById('docType').value;
        const teacherName = type === 'DLL' ? document.getElementById('teacher-dll').value : document.getElementById('teacher').value;
        const teachingTime = type === 'DLP' ? document.getElementById('dlp-time').value : document.getElementById('dll-time').value;
        
        let subjectVal = document.getElementById('subjectSelect').value;
        if (subjectVal === 'Manual') {
            subjectVal = document.getElementById('subjectManual').value;
        }

        return {
            docType: type,
            school: document.getElementById('school').value, 
            teacher: teacherName,
            dlpDate: document.getElementById('dlp-date').value, 
            teachingTime: teachingTime,
            dates: [
                document.getElementById('date-d1').value,
                document.getElementById('date-d2').value,
                document.getElementById('date-d3').value,
                document.getElementById('date-d4').value,
                document.getElementById('date-d5').value
            ],
            grade: document.getElementById('grade').value,
            subject: subjectVal, 
            quarter: document.getElementById('quarter').value,
            section: document.getElementById('section').value,
            topic: document.getElementById('topic').value, 
            cs: document.getElementById('cs').value,
            ps: document.getElementById('ps').value, 
            lc: document.getElementById('lc').value,
            model: document.getElementById('model').value, 
            teacherPos: document.getElementById('teacherPos').value,
            checker: document.getElementById('checker').value, 
            checkerPos: document.getElementById('checkerPos').value
        };
    }
    
    function liveUpdateHeader() {
        const val = document.getElementById('school').value;
        document.getElementById('displaySchoolHeader').innerText = val ? val.toUpperCase() : "SCHOOL NAME";
        renderEmptyLayout();
    }

    function renderEmptyLayout() {
        const data = getInputs();
        // If data is missing for rendering (because of select placeholders), handle gracefully
        const safeData = {
            ...data,
            school: data.school || "SCHOOL NAME",
            grade: data.grade || "",
            subject: data.subject || "",
            quarter: data.quarter || "",
            teacher: data.teacher || "",
            section: data.section || ""
        };

        const headerArea = document.getElementById('headerArea');
        const contentArea = document.getElementById('contentArea');

        document.getElementById('sigTeacherName').innerText = safeData.teacher.toUpperCase();
        document.getElementById('sigTeacherPos').innerText = data.teacherPos.toUpperCase();
        document.getElementById('sigCheckerName').innerText = data.checker.toUpperCase();
        document.getElementById('sigCheckerPos').innerText = data.checkerPos.toUpperCase();

        const isDLP = data.docType === 'DLP';
        // DLL defaults if type not selected yet
        const colSpan = isDLP ? 1 : 5;
        
        const colsHTML = isDLP 
            ? `<th style="width:70%">Detailed Content</th>` 
            : data.dates.map((d, i) => `<th class="col-day">${d ? 'Day '+(i+1)+'<br><span style="font-weight:normal;font-size:7pt">'+d+'</span>' : 'Day '+(i+1)}</th>`).join('');

        const dateDisplay = isDLP ? safeData.dlpDate : safeData.dates.filter(d => d).join(' / ');

        headerArea.innerHTML = `
            <table class="tpl-table" style="margin-bottom:5px;">
                <tr>
                    <td class="header-label">School</td><td class="header-val">${safeData.school.toUpperCase()}</td>
                    <td class="header-label">Grade Level</td><td class="header-val">${safeData.grade}</td>
                </tr>
                <tr>
                    <td class="header-label">Teacher</td><td class="header-val">${safeData.teacher.toUpperCase()}</td>
                    <td class="header-label">Learning Area</td><td class="header-val">${safeData.subject}</td>
                </tr>
                <tr>
                    <td class="header-label">Teaching Date/s</td><td class="header-val" style="font-size:8pt">${dateDisplay}</td>
                    <td class="header-label">Quarter</td><td class="header-val">${safeData.quarter}</td>
                </tr>
                <tr>
                     <td class="header-label">Teaching Time</td><td class="header-val">${safeData.teachingTime}</td>
                     <td class="header-label">Section</td><td class="header-val">${safeData.section}</td>
                </tr>
            </table>
        `;

        let gridRows = '';
        const steps = [
            { id: 'a', label: 'A. Review / Presenting new lesson' },
            { id: 'b', label: 'B. Establishing purpose' },
            { id: 'c', label: 'C. Presenting examples' },
            { id: 'd', label: 'D. Discussing new concepts #1' },
            { id: 'e', label: 'E. Discussing new concepts #2' },
            { id: 'f', label: 'F. Developing Mastery' },
            { id: 'g', label: 'G. Finding practical applications' },
            { id: 'h', label: 'H. Making generalizations' },
            { id: 'i', label: 'I. Evaluating learning' },
            { id: 'j', label: 'J. Additional activities' }
        ];

        gridRows += `
            <tr>
                <td style="background:#e5e7eb; font-weight:bold;">II. CONTENT</td>
                ${isDLP ? '<td id="d1-content" class="parsed-md"></td>' : 
                  '<td id="d1-content" class="parsed-md"></td><td id="d2-content" class="parsed-md"></td><td id="d3-content" class="parsed-md"></td><td id="d4-content" class="parsed-md"></td><td id="d5-content" class="parsed-md"></td>'}
            </tr>
            <tr><td colspan="${colSpan+1}" style="background:#e5e7eb; font-weight:bold;">III. LEARNING RESOURCES</td></tr>
            <tr><td class="dll-row-header">A. References</td><td colspan="${colSpan}" id="cell-resources-dll" class="parsed-md"></td></tr>
            <tr><td colspan="${colSpan+1}" style="background:#e5e7eb; font-weight:bold;">IV. PROCEDURES</td></tr>
        `;

        steps.forEach(s => {
            gridRows += `<tr><td class="dll-row-header">${s.label}</td>`;
            if(isDLP) {
                gridRows += `<td id="d1-proc-${s.id}" class="parsed-md"></td>`;
            } else {
                for(let i=1; i<=5; i++) gridRows += `<td id="d${i}-proc-${s.id}" class="parsed-md"></td>`;
            }
            gridRows += `</tr>`;
        });

        contentArea.innerHTML = `
            <table class="tpl-table dll-grid">
                <tr>
                    <th style="width:150px"></th>
                    ${colsHTML}
                </tr>
                <tr><td colspan="${colSpan+1}" style="background:#e5e7eb; font-weight:bold;">I. OBJECTIVES</td></tr>
                <tr><td class="dll-row-header">A. Content Standards</td><td colspan="${colSpan}" id="cell-cs" class="parsed-md">${safeData.cs || ''}</td></tr>
                <tr><td class="dll-row-header">B. Performance Standards</td><td colspan="${colSpan}" id="cell-ps" class="parsed-md">${safeData.ps || ''}</td></tr>
                <tr><td class="dll-row-header">C. Learning Competencies</td><td colspan="${colSpan}" id="cell-lc" class="parsed-md">${safeData.lc || ''}</td></tr>
                ${gridRows}
                <tr><td class="dll-row-header">V. REMARKS</td><td colspan="${colSpan}" style="height:30px"></td></tr>
                <tr><td class="dll-row-header">VI. REFLECTION</td><td colspan="${colSpan}" style="height:30px"></td></tr>
            </table>
        `;
    }

    function extractSection(text, tagName) {
        const regex = new RegExp(`<${tagName}>([\\s\\S]*?)<\/${tagName}>`, 'i');
        const match = text.match(regex);
        return match ? match[1].trim() : null;
    }

    function cleanOutput(text) {
        if(!text) return "";
        let clean = text.replace(/Support Pollinations\.AI[\s\S]*/gi, '');
        clean = clean.replace(/```xml/gi, '').replace(/```/gi, ''); 
        
        // Remove ALL Phase Labels like [ACTIVITY PHASE] or **[ENGAGE PHASE]**
        const phaseRegex = /(\*\*|\[)?\[?(ACTIVITY|ANALYSIS|ABSTRACTION|APPLICATION|ENGAGE|EXPLORE|EXPLAIN|ELABORATE|EVALUATE|ELICIT|EXTEND) PHASE\]?(\*\*|\])?/gi;
        clean = clean.replace(phaseRegex, '');
        
        const filters = [
            /AFTER Application\/Elaborate, insert Rubric:/gi,
            /\*\*AFTER Application\/Elaborate, insert Rubric:\*\*/gi,
            /\(INTERNAL:[\s\S]*?\)/gi,
        ];
        filters.forEach(regex => { clean = clean.replace(regex, ''); });
        return clean;
    }
    
    function showDevInfo() {
        Swal.fire({
            title: '<strong>LESSON PLANNER Pro</strong>',
            icon: 'info',
            html: '<b>COGON NATIONAL HIGH SCHOOL</b><br>Developed by: <b>Joram V. Castro</b>',
            showCloseButton: true, confirmButtonText: 'Close', confirmButtonColor: '#2563eb'
        });
    }

    function downloadPDF() {
        const element = document.getElementById('paperContent');
        const opt = {
            margin:       0.2,
            filename:     'LessonPlan.pdf',
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2 },
            jsPDF:        { unit: 'in', format: 'a4', orientation: 'landscape' }
        };
        html2pdf().set(opt).from(element).save();
    }

    function getBase64Image(img) {
        if (img.src.startsWith("data:")) return img.src; 
        const canvas = document.createElement("canvas");
        canvas.width = img.width;
        canvas.height = img.height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(img, 0, 0);
        return canvas.toDataURL("image/png");
    }

    function exportToWord() {
        const paper = document.getElementById("paperContent");
        
        const logoImg = document.getElementById('headerLogo');
        let logoBase64 = '';
        if(logoImg && logoImg.style.display !== 'none') {
            try { logoBase64 = getBase64Image(logoImg); } catch(e) { console.warn('Logo conversion failed'); }
        }

        let htmlContent = paper.innerHTML;
        if(logoBase64) {
            htmlContent = htmlContent.replace(/src="[^"]*"/, `src="${logoBase64}"`);
        }
        
        const preHtml = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Lesson Plan</title>";
        
        // Inline CSS for Word strict layout
        const css = "<style>" +
                    "@page { size: 29.7cm 21cm; margin: 1cm; mso-page-orientation: landscape; }" +
                    "body { font-family: Arial, sans-serif; width: 100%; }" +
                    "table { border-collapse: collapse; width: 100%; table-layout: fixed; }" +
                    "td, th { border: 1px solid black; padding: 5px; vertical-align: top; word-wrap: break-word; }" +
                    ".header-label { background: #eee; font-weight: bold; }" +
                    ".dll-row-header { background: #f3f4f6; font-weight: bold; }" +
                    ".official-header { text-align: center; }" + 
                    "p { margin: 0; padding: 0; }" +
                    "</style>";
        const postHtml = "</body></html>";
        
        const sourceHTML = preHtml + css + "<body>" + htmlContent + postHtml;
        const source = 'data:application/vnd.ms-word;charset=utf-8,' + encodeURIComponent(sourceHTML);
        
        const fileDownload = document.createElement("a");
        document.body.appendChild(fileDownload);
        fileDownload.href = source;
        fileDownload.download = 'LessonPlan.doc';
        fileDownload.click();
        document.body.removeChild(fileDownload);
    }
    
    function validateInputs() {
        // Clear previous errors
        document.querySelectorAll('.input-error').forEach(el => el.classList.remove('input-error'));
        
        const data = getInputs();
        let isValid = true;
        let missingFields = [];

        // Required Fields List
        const required = [
            { id: 'docType', name: 'Document Type', val: data.docType },
            { id: 'grade', name: 'Grade Level', val: data.grade },
            { id: 'quarter', name: 'Quarter', val: data.quarter },
            { id: 'subjectSelect', name: 'Subject', val: data.subject },
            { id: 'model', name: 'Instructional Model', val: data.model },
            { id: 'section', name: 'Section', val: data.section },
            { id: 'topic', name: 'Topic', val: data.topic },
            { id: 'cs', name: 'Content Standards', val: data.cs },
            { id: 'ps', name: 'Performance Standards', val: data.ps },
            { id: 'lc', name: 'Learning Competency', val: data.lc },
            { id: 'teacherPos', name: 'Teacher Position', val: data.teacherPos },
            { id: 'checker', name: 'Checker Name', val: data.checker },
            { id: 'checkerPos', name: 'Checker Position', val: data.checkerPos }
        ];

        // Conditional Required Fields
        if (data.docType === 'DLP') {
            required.push({ id: 'teacher', name: 'Teacher Name', val: data.teacher });
            required.push({ id: 'dlp-date', name: 'Teaching Date', val: data.dlpDate });
            required.push({ id: 'dlp-time', name: 'Teaching Time', val: data.teachingTime });
        } else if (data.docType === 'DLL') {
            required.push({ id: 'teacher-dll', name: 'Teacher Name', val: data.teacher });
            required.push({ id: 'dll-time', name: 'Teaching Time', val: data.teachingTime });
            // DLL needs at least one date
            const hasDate = data.dates.some(d => d !== "");
            if (!hasDate) {
                isValid = false;
                missingFields.push("At least one Date");
                // Highlight all date inputs
                for(let i=1; i<=5; i++) document.getElementById(`date-d${i}`).classList.add('input-error');
            }
        }

        // Check Loop
        required.forEach(item => {
            if (!item.val || item.val.trim() === "") {
                isValid = false;
                missingFields.push(item.name);
                const el = document.getElementById(item.id);
                if(el) el.classList.add('input-error');
            }
        });

        if (!isValid) {
            Swal.fire({
                icon: 'error',
                title: 'Missing Required Fields',
                html: `Please fill in the following mandatory fields:<br><b>${missingFields.join(', ')}</b>`
            });
        }
        return isValid;
    }

    async function generatePlan() {
        if (!validateInputs()) return;

        const data = getInputs();
        
        if (window.location.protocol === 'file:') {
            Swal.fire({ icon: 'error', title: 'Offline Mode Error', html: 'You cannot run this file directly.<br>Please use <b>Live Server</b> in VS Code or upload to <b>GitHub Pages</b>.' });
            return;
        }

        renderEmptyLayout();
        const btn = document.querySelector('.btn-generate'); const spinner = document.getElementById('spin');
        btn.disabled = true; spinner.style.display = 'inline-block';
        
        let prompt = "";
        const isDLP = data.docType === 'DLP';
        const model = data.model;

        let modelInstructions = "";
        if (model === "4As") {
            modelInstructions = `
                STRICT 4A's MAPPING TO DEPED STEPS:
                - ACTIVITY Phase -> Put inside Step C (Presenting examples) and D (Discussing #1).
                - ANALYSIS Phase -> Put inside Step E (Discussing #2).
                - ABSTRACTION Phase -> Put inside Step H (Generalization).
                - APPLICATION Phase -> Put inside Step G (Application).
            `;
        } else if (model === "5Es") {
            modelInstructions = `
                STRICT 5E's MAPPING TO DEPED STEPS:
                - ENGAGE Phase -> Put inside Step A (Review) and B (Purpose).
                - EXPLORE Phase -> Put inside Step C (Examples) and D (Discussing #1).
                - EXPLAIN Phase -> Put inside Step E (Discussing #2) and F (Mastery).
                - ELABORATE Phase -> Put inside Step G (Application) and H (Generalization).
                - EVALUATE Phase -> Put inside Step I (Evaluation).
            `;
        } else {
             modelInstructions = `
                STRICT 7E's MAPPING:
                - ELICIT/ENGAGE -> Step A/B.
                - EXPLORE -> Step C/D.
                - EXPLAIN -> Step E.
                - ELABORATE -> Step F/G/H.
                - EVALUATE -> Step I.
                - EXTEND -> Step J.
             `;
        }

        const commonInst = `
            Standards Inputs: CS Input: "${data.cs}", PS: "${data.ps}", LC: "${data.lc}".
            
            MANDATORY RULES:
            1. **Content Standards (<CS>)**: MUST include Cognitive, Psychomotor, and Affective objectives AND Integration of 3 subjects.
               FORMATTING: Separate these items with double newlines (\n\n) so they appear on new lines in the table.
            2. **Procedures**: Follow the ${model} Model using the mapping below. DO NOT include phase labels like [ACTIVITY] in the output text, just the content.
            ${modelInstructions}
            3. **Rubrics**: For EVERY procedure step that involves an activity, include a SIMPLE RUBRIC (e.g., "5pts: Accurate... 3pts: ...").
            4. **Resources**: Specific references/links required.
        `;

        if (isDLP) {
            prompt = `
                Act as DepEd Teacher. Create a DETAILED Lesson Plan (DLP) for "${data.topic}" (${data.subject}, ${data.grade}) using the **${model} Model**.
                ${commonInst}
                
                Generate XML Tags:
                <CS>Content Stds\n\nCognitive: ...\n\nPsychomotor: ...\n\nAffective: ...\n\nIntegration: ...</CS> 
                <RESOURCES>List references</RESOURCES>

                <D1_TOPIC>(Detailed Content Topic)</D1_TOPIC>
                <D1_A>(Step A content)</D1_A> <D1_B>(Step B content)</D1_B> <D1_C>(Step C content)</D1_C>
                <D1_D>(Step D content)</D1_D> <D1_E>(Step E content)</D1_E> <D1_F>(Step F content)</D1_F> 
                <D1_G>(Step G content)</D1_G> <D1_H>(Step H content)</D1_H> <D1_I>(Step I content)</D1_I> <D1_J>(Step J content)</D1_J>
                
                IMPORTANT: YOU MUST GENERATE TEXT FOR EVERY SINGLE TAG ABOVE. DO NOT SKIP ANY.
                NOTE: Omit REMARKS/REFLECTION. Use Markdown.
            `;
        } else {
            const activeIndices = [];
            data.dates.forEach((d, i) => { if(d) activeIndices.push(i+1); });
            const activeDaysStr = activeIndices.length > 0 ? `Generate content ONLY for these days: ${activeIndices.map(i=>'Day '+i).join(', ')}.` : "Generate content for all 5 days.";

            prompt = `
                Act as DepEd Teacher. Create a 5-DAY Daily Lesson Log (DLL) for "${data.topic}" (${data.subject}, ${data.grade}) using **${model}**.
                ${commonInst}
                ${activeDaysStr}

                Generate XML Tags:
                <CS>Content Stds\n\nCognitive: ...\n\nPsychomotor: ...\n\nAffective: ...\n\nIntegration: ...</CS> 
                <RESOURCES>Refs</RESOURCES>

                Day 1: <D1_TOPIC>...</D1_TOPIC> <D1_A>...</D1_A> <D1_B>...</D1_B> <D1_C>...</D1_C> <D1_D>...</D1_D> <D1_E>...</D1_E> <D1_F>...</D1_F> <D1_G>...</D1_G> <D1_H>...</D1_H> <D1_I>...</D1_I> <D1_J>...</D1_J>
                Day 2: <D2_TOPIC>...</D2_TOPIC> <D2_A>...</D2_A> ... <D2_J>...</D2_J>
                Day 3: <D3_TOPIC>...</D3_TOPIC> <D3_A>...</D3_A> ...
                Day 4: <D4_TOPIC>...</D4_TOPIC> <D4_A>...</D4_A> ...
                Day 5: <D5_TOPIC>...</D5_TOPIC> <D5_A>...</D5_A> ...
                
                IMPORTANT: YOU MUST GENERATE TEXT FOR EVERY SINGLE TAG FOR THE ACTIVE DAYS.
            `;
        }

        try {
            const response = await fetch('https://text.pollinations.ai/', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ messages: [{ role: 'system', content: 'You are a DepEd Lesson Plan generator. Use XML Tags.' }, { role: 'user', content: prompt }], model: 'openai', seed: Math.floor(Math.random() * 999999) }) });
            if (response.status === 502) throw new Error("Server overloaded (502). Wait 30s & try again.");
            let text = await response.text();
            text = cleanOutput(text);

            const cs = extractSection(text, 'CS');
            const res = extractSection(text, 'RESOURCES');
            if(cs) document.getElementById('cell-cs').innerHTML = marked.parse(cs);
            // PS and LC are populated from manual inputs, not AI overwriting them, unless specific prompt changes.
            // Current prompt asks AI to output PS/LC based on input, but let's rely on user input for these specific fields as requested.
            
            if(res) document.getElementById('cell-resources-dll').innerHTML = marked.parse(res);

            const maxDays = isDLP ? 1 : 5;
            for(let i=1; i<=maxDays; i++) {
                if(!isDLP && !document.getElementById(`date-d${i}`).value) continue;

                const content = extractSection(text, `D${i}_TOPIC`);
                if(content) document.getElementById(`d${i}-content`).innerHTML = marked.parse(content);
                
                const steps = ['A','B','C','D','E','F','G','H','I','J'];
                steps.forEach(s => {
                    let tag = `D${i}_${s}`;
                    const val = extractSection(text, tag);
                    if(val) document.getElementById(`d${i}-proc-${s.toLowerCase()}`).innerHTML = marked.parse(val);
                });
            }
            Swal.fire({ icon: 'success', title: 'Plan Generated!', timer: 1500, showConfirmButton: false });
        } catch (e) { 
            Swal.fire({ icon: 'error', title: 'Server Error', text: e.message });
        } finally { btn.disabled = false; spinner.style.display = 'none'; }
    }
    
    toggleInputs();
    liveUpdateHeader();
</script>
</body>
</html>
